# Social Image Server

Automatically generate unique OG images for every page of your website. Inspired by [image.social](https://image.social/).

```html
<meta property="og:image" content="https://your-server/get?url=turso.tech/pricing" />
```

<table width="100%">
  <thead>
    <tr>
      <th width="50%">Before</th>
      <th width="50%">After</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td width="50%"><img src="https://henrygd-assets.b-cdn.net/social-image-server/before.webp" alt="example of turso.tech/pricing link which is missing an og:image as of may 11 2024"/></td>
      <td width="50%"><img src="https://henrygd-assets.b-cdn.net/social-image-server/after.webp?g" alt="example of turso.tech/pricing link using an image generated by the server as it's og:image"/></td>
    </tr>
  </tbody>
</table>

## Installation

### Binary

Download and run the latest binary from the [releases page](https://github.com/henrygd/social-image-server/releases) or use the command below. You must have Chrome or Chromium installed on your system.

Use the `--update` flag to update to the latest version.

```bash
curl -sL "https://github.com/henrygd/social-image-server/releases/latest/download/social-image-server_$(uname -s)_$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/').tar.gz" | tar -xz -O social-image-server | tee ./social-image-server >/dev/null && chmod +x social-image-server && ls social-image-server
```

### Docker

See the example [docker-compose](https://github.com/henrygd/social-image-server/blob/main/docker-compose.yml). The `chromedp/headless-shell` is needed to provide a browser instance. Other headless Chrome images should work but seem to be much larger.

It may be possible to use a native Chrome / Chromium installation by giving the container access to your host ports and running the browser with the `--remote-debugging-port` flag.

## Usage

The `/get` endpoint generates an image for any URL you pass in via the `url` query parameter.

Add an `og:image` meta tag into the `<head>` of your website:

```html
<meta property="og:image" content="https://yourserver.com/get?url=example.com" />
```

It's best to add this once in a layout template, rather than doing it for every page. See [Framwork Examples](#framework-examples).

A useful site for previewing or generating boilerplate HTML is [heymeta.com](https://www.heymeta.com/).

## URL Parameters

| Name        | Default | Description                                                                                                                                                                                     |
| ----------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `url`       | -       | URL to generate image for.                                                                                                                                                                      |
| `width`     | 1400    | Width of browser viewport in pixels (max 2500). Output image is scaled to `IMG_WIDTH` width.                                                                                                    |
| `delay`     | 0       | Delay in milliseconds after page load before generating image.                                                                                                                                  |
| `dark`      | false   | Sets prefers-color-scheme to dark.                                                                                                                                                              |
| `cache_key` | -       | Regenerates image if changed. This is validated using your origin URL. If the `cache_key` doesn't match, the server will return a previously cached image (or error if no cached image exists). |
| `_regen_`   | -       | Do not use in public URLs. Forces full regeneration on every request. Use to manually purge a URL or tweak params, then remove. Must match `REGEN_KEY` value.                                   |

## Environment Variables

| Name              | Default | Description                                                                                                                        |
| ----------------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `ALLOWED_DOMAINS` | -       | Restrict to certain domains. Example: "example.com,example.org"                                                                    |
| `CACHE_TIME`      | 30 days | Time to cache images on server.                                                                                                    |
| `DATA_DIR`        | ./data  | Directory to store program data (images and database).                                                                             |
| `FONT_FAMILY`     | -       | Change browser fallback font. Must be available on your system / image.                                                            |
| `IMG_FORMAT`      | jpeg    | Image format. Valid values: "jpeg", "png".                                                                                         |
| `IMG_QUALITY`     | 92      | Compression quality (jpeg only).                                                                                                   |
| `IMG_WIDTH`       | 2000    | Width of output image in pixels.                                                                                                   |
| `LOG_LEVEL`       | info    | Logging level. Valid values: "debug", "info", "warn", "error".                                                                     |
| `PERSIST_BROWSER` | 5m      | Time to keep the browser process running after the last image generation. Valid units: "ms", "s", "m", "h". See FAQ for more info. |
| `PORT`            | 8080    | Port to listen on.                                                                                                                 |
| `REGEN_KEY`       | -       | Key used to force bypass cache.                                                                                                    |
| `REMOTE_URL`      | -       | Connect to an existing Chrome DevTools instance using a WebSocket URL. Example: ws://localhost:9222                                |

## Frequently Asked Questions

### Does the server require Chrome or Chromium running in the background indefinitely?

Only if you use `REMOTE_URL` to connect with a remote browser process. Otherwise the server will manage headless browser processes as necessary.

If it needs to generate an image and there is no process already running, it will start one. After the image is generated, a timer is started. If another image generation occurs within the timer duration, the browser process is reused, and the timer is reset. If the timer reaches zero, the browser process is terminated.

This way active servers will get the performance benefits of reusing the browser process, while less active servers will not need to keep Chrome running in the background forever.

The timer duration can be configured with the `PERSIST_BROWSER` environment variable.

### How can I add custom styles or scripts when the screenshot is taken?

The server's outgoing request to websites always includes the URL parameter `og-image-request=true`, so check for that.

### Why does the image look different than in my browser?

Probably because the website isn't providing fonts over the network, and the browser is using a different default font than your personal setup.

If you're not using a remote browser instance, you should be able to change the font using the `FONT_FAMILY` environment variable.

If you are using a remote browser, try setting the `--system-font-family` flag. Check the [docker-compose](https://github.com/henrygd/social-image-server/blob/main/docker-compose.yml) for an example.

### Why is webp not an `IMG_FORMAT` option?

From what I can tell, Facebook and LinkedIn (and likely others) don't support webp open graph images. If I'm wrong, let me know and I'll add it.

## Remote Browser Instance

Use the `REMOTE_URL` environment variable to connect to an existing instance of Chrome.

This is only necessary / recommended if you're using docker or you don't want to install Chromium.

### Examples

Using the chromedp `headless-shell` docker image (see [docker-compose.yml](https://github.com/henrygd/social-image-server/blob/main/docker-compose.yml)).

```sh
docker run -d -p 127.0.0.1:9222:9222 --rm chromedp/headless-shell:latest
```

Using Chrome directly (most flags are from [chromedp's default options](https://pkg.go.dev/github.com/chromedp/chromedp@v0.9.5#pkg-variables)).

If using docker, you'll need to give your container access to your host's ports.

```sh
google-chrome-stable --remote-debugging-port=9222 --headless=new --hide-scrollbars --font-render-hinting=none --disable-background-networking --enable-features=NetworkService,NetworkServiceInProcess --disable-extensions --disable-breakpad --disable-backgrounding-occluded-windows --disable-default-apps --disable-background-timer-throttling --disable-features=site-per-process,Translate,BlinkGenPropertyTrees --disable-hang-monitor --disable-client-side-phishing-detection --disable-popup-blocking --disable-prompt-on-repost --disable-sync --disable-translate --metrics-recording-only --no-first-run --password-store=basic --use-mock-keychain
```

## Response headers

The server includes status headers for successful image requests.

### X-Og-Cache

| Value | Description             |
| ----- | ----------------------- |
| HIT   | Cached image was served |
| MISS  | New image was generated |

### X-Og-Code

| Value | Description                                                                          |
| ----- | ------------------------------------------------------------------------------------ |
| 0     | New image generated because it did not exist in cache                                |
| 1     | New image generated due to `_regen_` parameter                                       |
| 2     | Found matching cached image                                                          |
| 3     | `cache_key` does not match `cache_key` on origin URL. Using previously cached image. |

## Framework examples

These examples use an automatically updated `cache_key` when possible, but you can replace the value with any string, or just remove it.

Feel free to improve these or contribute others.

### SvelteKit

```svelte
<!-- +layout.svelte -->
<script>
  import { version } from '$app/environment'
  import { page } from '$app/stores'
</script>

<sveltekit:head>
  <meta
    property="og:image"
    content="https://your-server/get?url=yourdomain.com{$page.url.pathname}&cache_key={version}"
  />
</sveltekit:head>
```

### Astro

```astro
<!-- Layout.astro -->
---
import {version} from '../../package.json';
---

<head>
  <meta name="og:image" content={`https://your-server/get?url=${Astro.url}&cache_key=${version}`} />
</head>
```

### WordPress

```php
// header.php
<?php
  $page_url = home_url($_SERVER['REQUEST_URI']);
  $version = wp_get_theme()->get('Version');
  $og_image_url = "https://your-server/get?url=$page_url&cache_key=$version";
?>

<head>
  <meta property="og:image" content="<?php echo $og_image_url ?>"/>
</head>
```
